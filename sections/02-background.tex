\section{Background}%
\label{sec:background}

We begin by providing an overview of secure enclaves in general
(\S~\ref{sec:enclaves}), followed by the AWS Nitro system (\S~\ref{sec:nitro})
and Nitro enclaves (\S~\ref{sec:nitro-enclaves}).  We finally compare Nitro
enclaves to SGX-based enclaves (\S~\ref{sec:comparison}).

\subsection{Secure enclaves}%
\label{sec:enclaves}

Computers operate on data that is at rest, in transit, and in use.  We have
well-understood and practical ways to protect data at rest (e.g., full disk
encryption) and in transit (e.g., TLS) but only limited solutions for data that
is in use.  Cryptography provides solutions in the form of fully homomorphic
encryption (FHE) and secure multiparty computation (MPC) but for many
applications, those building blocks remain too slow and cumbersome.  Trusted
execution environments---in particular in the form of ``secure
enclaves''---provide an alternative that is rooted in hardware and code.  Unlike
FHE and MPC, enclaves perform at native (or near-native) execution speed because
they are general-purpose computing environments that are not limited to the
computation of carefully designed functions.  Conceptually, enclaves are
isolated execution environments that are shielded off from a computer's main
execution environment, which runs the untrustworthy (from the enclave's point of
view) operating system.  Enclaves offer various security properties but in the
context of this work, we rely on the following three:

\textbf{Confidentiality}: An unauthorized entity (e.g., the operating system)
must not be able to observe the data that an enclave is processing.

\textbf{Integrity}: An unauthorized entity must not be able to modify the data
that the enclave is processing, or the code that it is running.

\textbf{Verifiability}: A separate entity (e.g., an end user) must be able to
verify if the enclave is running the code that its operator claims it is
running.

Major hardware vendors offer CPUs that implement secure enclaves: Intel has SGX
(and soon TDX~\cite{tdx}), ARM has TrustZone, and AMD has SEV.  A frequent
critique of these industry efforts focuses on their proprietary nature. The
community has a conceptual understanding of the mechanisms behind enclaves but
their exact hardware implementation is not disclosed, which served as motivation
towards an open source enclave~\cite{Lee20a}.  In practice, enclaves promise to
be useful in situations where a system must process sensitive data while
simultaneously be shielded off from the complexity (and subsequent insecurity)
of general-purpose computers.

\subsection{The AWS Nitro system}%
\label{sec:nitro}

Nitro enclaves are virtual machines that run on dedicated hardware that is not
shared with an enclave's EC2 host.  The technology that enforces isolation
between the enclave and its EC2 host also enforces isolation between any two
given EC2 instances: the Nitro system.  Before covering enclaves, we explain how
the Nitro system works---first by discussing its three key components.

\textbf{Nitro cards}: While physically connected to a server's main board via
PCIe, Nitro cards are dedicated and custom-built hardware and software that runs
independently of a server's main board.  Nitro cards implement the interfaces
that allow for the management of a server's computational, memory, and storage
needs, among other things.  A Nitro card also provides a server's hardware root
of trust and is responsible for firmware updates, secure boot, and acts as an
interface between the server and the EC2 control plane~\cite[pp.
7--10]{Bean2022a}.

\textbf{Nitro security chip}: The Nitro card acts independently of the system main
board.  The purpose of the Nitro security chip, which is controlled by the Nitro
card, is to extend the Nitro card's control over the system main board.  One of
the chip's responsibilities is to prevent the CPU from updating the system's
firmware when run in bare metal mode~\cite[pp.~10--11]{Bean2022a}.

\textbf{Nitro hypervisor}:
The hypervisor is a firmware-like component that receives commands from the
Nitro card.  The hypervisor is stripped of any non-essential code: it does not
contain networking code, file systems, shells, or other utilities that would
allow a successful attacker to access other
infrastructure~\cite[pp.~11--12]{Bean2022a}.

Other design decisions are meant to provide defense in depth.  First, by
design, the Nitro system has no operator access, i.e., operators are unable to
log in to an EC2 Nitro system and inspect memory or access customer
data~\cite[p.~15]{Bean2022a}. Second, the Nitro system is designed to
communicate passively, i.e., system components never initiate outgoing
connections during production operations.

Of particular interest is how the Nitro system aims to prevent side channel
attacks: customer instances never share a given CPU core in parallel.  If two
customers use a CPU core sequentially, the hypervisor ensures that state is
cleared in between use.  Depending on the instance, cores may be exclusively
allocated to a customer, which includes Nitro enclaves.  This means that L1 and
L2 caches are also never shared.  Last-level cache lines may be shared but only
non-simultaneously.  Amazon's documentation further
states~\cite[p.~19]{Bean2022a}:

\begin{quote}
By virtue of its function, only relatively infrequently accessed data is
referenced in last-level cache lines.  Side-channels typically require a very
large and statistically relevant number of samples in order to over-come the
noise present in systems.
\end{quote}

\subsection{Nitro enclaves}%
\label{sec:nitro-enclaves}

Nitro enclaves inherit the isolation and security properties of the Nitro
system.  When an EC2 host system launches a Nitro enclave, it ``sacrifices'' at
least one of its CPUs and some of its memory pages to the enclave.  These
resources are subsequently unavailable to the EC2 host and exclusively used by
the enclave.  The same isolation mechanism that protects individual customer EC2
instances from each other also protects the Nitro enclave from its host.

\begin{figure}[t]
  \centering
  \input{sections/figures/dev-workflow}
  \caption{The development workflow for compiling enclave applications.}%
  \label{fig:dev-workflow}
\end{figure}

On the software level, Nitro enclaves are virtual machines.  They have their own
Linux kernel that is independent from the host.  Customers can create enclave
images from a Docker image that contains the enclave application.  Amazon
provides a command line tool, nitro-cli~\cite{nitro-cli}, which compiles a
Docker image into an enclave image file (EIF).  Figure~\ref{fig:dev-workflow}
illustrates the process.  After compilation, nitro-cli prints a number of
platform configuration registers (PCRs) that contain SHA-384 hashes over
different layers of the enclave image file.  Table~\ref{tab:pcr} shows the six
available PCRs.  PCR0 is of particular importance for remote attestation as we
will explain later.

\begin{table}[t]
    \centering
    \begin{tabular}{r l}
    \toprule
      PCR \# & SHA-384 hash of\ldots \\
    \midrule
      0 & Enclave image file \\
      1 & Linux kernel \\
      2 & Application \\
      3 & IAM role assigned to the host instance \\
      4 & Instance ID of the host instance \\
      8 & Enclave image file signing certificate \\
    \bottomrule
    \end{tabular}
    \caption{The available platform configuration registers (PCRs) and the
    meaning behind them.}%
    \label{tab:pcr}
\end{table}

By design, Nitro enclaves have very limited abilities to communicate with the
outside world.  Lacking a dedicated networking interface, Nitro enclaves can
only communicate with their EC2 host via a VSOCK interface~\cite{vsock}.
Originally proposed for communication between a hypervisor and its virtual
machines, AWS repurposed the VSOCK interface to serve as communication channel
between an enclave and its parent EC2 instance.  From a developer's point of
view, the VSOCK interface is a point-to-point interface connecting the two.  On
the network layer, 32-bit context IDs take the role of IP addresses in VSOCK
interfaces.  For example, the enclave may have context ID 4 while its parent EC2
instance may have context ID 3.  On the transport layer, one can use the same
protocols that one would use over the IP-based address family; namely TCP, UDP,
et cetera.

\subsection{Nitro enclaves versus SGX}%
\label{sec:comparison}

We now make an attempt to compare how Nitro enclaves and SGX differ in their
threat model, their development model, and in the way they can address security
vulnerabilities.

% Hard to get authoritative information on SGX TCB and threat model.  Some
% decent (yet incomplete) information:
% https://people.csail.mit.edu/alinush/6.858-fall-2014/2015/l08-sgx.html
% https://community.intel.com/t5/Intel-Software-Guard-Extensions/SGX-threat-Model/m-p/1187359
\textbf{Threat model}:
Both Nitro enclaves and SGX protect against compromise of the host operating
system.  SGX further protects against compromise of any component other than the
CPU itself, which includes---if present---the hypervisor.  Specifically, SGX
assumes that there are no flaws in the CPU's silicon or microcode, and the
private key is not compromised.  While not explicitly stated, Amazon's design
document suggests that Nitro enclaves assume that the Nitro system (including
the Nitro card, the security chip, and the hypervisor) is trusted.  Both Nitro
enclaves and SGX assume that side channel attacks are not feasible.  For SGX,
this assumption has not held~\cite{Nilsson20a,Fei2021a}.

\textbf{Development}:
Intel's SGX was not designed to seamlessly move entire applications into the
context of an enclave because the libc that is provided by Intel's SDK lacks
support for many functions and system calls.  Instead, application developers
were meant to partition their application, i.e., move trusted code fragments
into the enclave while the remaining code ran outside the enclave.  However,
projects like Haven~\cite{Baumann2014a} and SCONE~\cite{Arnautov2016a} made it
possible to run entire unmodified applications inside an SGX enclave.  Nitro
enclaves in contrast provide by default what Arnautov et al.\ developed in their
OSDI'14 paper~\cite{Arnautov2016a}: a way to seamlessly run a Docker container
inside an enclave.

\textbf{Addressing vulnerabilities}:
What means do Intel and Amazon have to mitigate attacks against their enclave
technology?  Amazon is in possession and control of all hardware and software.
A hardware flaw in Nitro cards may prove expensive and complicated to fix but a
fix is feasible without involving the customer.  Intel has less flexibility
considering that their CPUs are under customer possession.  Some SGX
vulnerabilities have been addressed by updating CPU microcode, which may be a
standard procedure for cloud providers but certainly less so for end users.

Finally, as of March 2023, Intel is in the process of rolling out their
``Trusted Domain Extensions'' processor feature, which is conceptually similar
to Nitro enclaves in the sense that it aims to protect virtual machines from
both the hypervisor and all other software, including the operating
system~\cite{tdx}.
